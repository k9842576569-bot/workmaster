<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Global Edge Work Master</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f2f2f2;padding:10px;}
.box{max-width:900px;margin:auto;background:#fff;padding:15px;border-radius:8px;box-shadow:0 0 10px #aaa;}
input,button,textarea,select{padding:10px;font-size:16px;margin:5px 0;}
button{background:#007bff;color:white;border:none;border-radius:5px;}
.hidden{display:none;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
td,th{border:1px solid #ccc;padding:6px;}
th{background:#eee;}
.role{color:green;font-weight:bold;}
textarea{width:100%;height:120px;}

.search-row{display:flex;gap:6px;}
.search-row input{flex:1;}
.search-row button{width:120px;background:#28a745;}
.time-row{display:flex;gap:6px;}
.time-row input{flex:1;}
.time-row select{width:90px;}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
<h2>Staff Login</h2>
<input id="loginMobile" placeholder="Mobile Number">
<input id="loginPassword" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<p id="loginError" style="color:red;"></p>
</div>

<!-- MAIN SCREEN -->
<div class="box hidden" id="mainBox">
<h2>Work Master</h2>
<p id="welcome"></p>
<p id="role" class="role"></p>

<h3>New Entry</h3>

<label>Work Date</label>
<input type="date" id="workDate">

<!-- SEARCH -->
<div class="search-row">
  <input id="branchCode" placeholder="Enter Branch Code">
  <button onclick="searchBranch()">SEARCH</button>
</div>

<input id="branchName" placeholder="Branch Name" readonly>

<!-- Hidden fields -->
<input type="hidden" id="district">
<input type="hidden" id="pincode">

<label>In Time</label>
<div class="time-row">
  <input id="inTime" placeholder="HH:MM">
  <select id="inAmPm">
    <option>AM</option>
    <option>PM</option>
  </select>
</div>

<label>Out Time</label>
<div class="time-row">
  <input id="outTime" placeholder="HH:MM">
  <select id="outAmPm">
    <option>AM</option>
    <option>PM</option>
  </select>
</div>

<textarea id="remarks" placeholder="Remarks (Long text allowed)"></textarea>

<button onclick="addEntry()">Save Entry</button>

<button id="exportBtn" onclick="exportExcel()">Export Excel</button>
<button onclick="openChange()">Change Password</button>
<button onclick="logout()" style="background:red;">Logout</button>

<table>
<thead>
<tr>
<th>SlNo</th>
<th>Date</th>
<th>Branch Code</th>
<th>Branch Name</th>
<th>District</th>
<th>Pincode</th>
<th>In</th>
<th>Out</th>
<th>Remarks</th>
</tr>
</thead>
<tbody id="dataBody"></tbody>
</table>

<p id="msg" style="color:green;"></p>
</div>

<!-- CHANGE PASSWORD -->
<div class="box hidden" id="changeBox">
<h2>Change Password</h2>
<input type="password" id="oldPass" placeholder="Old Password">
<input type="password" id="newPass" placeholder="New Password">
<input type="password" id="confirmPass" placeholder="Confirm Password">
<button onclick="updatePassword()">Update</button>
<button onclick="back()">Back</button>
<p id="passMsg" style="color:red;"></p>
</div>

<script>
let staffData={}, branchData={}, currentUser=null;
let workData = JSON.parse(localStorage.getItem("workData")) || [];

/* LOAD FILES */
fetch("staff_master.json").then(r=>r.json()).then(d=>staffData=d);
fetch("branch_master.json").then(r=>r.json()).then(d=>branchData=d);

/* LOGIN */
function login(){
  for(let k in staffData){
    if(staffData[k].Mobile===loginMobile.value && staffData[k].Password===loginPassword.value){
      currentUser = staffData[k];
      loginBox.classList.add("hidden");
      mainBox.classList.remove("hidden");
      welcome.innerText = "Welcome: " + currentUser.Name;
      role.innerText = "Role: " + currentUser.Role;
      exportBtn.style.display = currentUser.Role==="ADMIN" ? "block" : "none";
      render();
      return;
    }
  }
  loginError.innerText="Invalid Login!";
}

/* LOGOUT */
function logout(){ location.reload(); }

/* BRANCH SEARCH */
function searchBranch(){
  let code = branchCode.value.trim();
  if(branchData[code]){
    branchName.value = branchData[code].BANCH_NAME;
    district.value = branchData[code].DISTRICT;
    pincode.value = branchData[code].PINCODE;
  }else{
    alert("Branch Code Not Found!");
    branchName.value="";
  }
}

/* ✅ DUPLICATE PREVENTION + SAVE */
function addEntry(){

  let date = workDate.value;
  let code = branchCode.value.trim();
  let name = branchName.value;
  let dist = district.value;
  let pin = pincode.value;
  let inT = inTime.value + " " + inAmPm.value;
  let outT = outTime.value + " " + outAmPm.value;
  let rem = remarks.value;

  if(!date || !code || !name){
    alert("Date, Branch Code & Branch Name Required!");
    return;
  }

  // ✅ BLOCK SAME DATE + SAME BRANCH
  let duplicate = workData.find(x => x.date === date && x.code === code);
  if(duplicate){
    alert("❌ This Branch Already Entered For This Date!");
    return;
  }

  let rec = {
    date:date,
    code:code,
    name:name,
    dist:dist,
    pin:pin,
    in:inT,
    out:outT,
    rem:rem
  };

  workData.push(rec);
  localStorage.setItem("workData",JSON.stringify(workData));
  msg.innerText="✅ Saved Successfully!";
  render();
}

/* SHOW TABLE */
function render(){
  dataBody.innerHTML="";
  workData.forEach((x,i)=>{
    dataBody.innerHTML+=`
    <tr>
    <td>${i+1}</td>
    <td>${x.date}</td>
    <td>${x.code}</td>
    <td>${x.name}</td>
    <td>${x.dist}</td>
    <td>${x.pin}</td>
    <td>${x.in}</td>
    <td>${x.out}</td>
    <td>${x.rem}</td>
    </tr>`;
  });
}

/* EXPORT CSV (ADMIN ONLY) */
function exportExcel(){
  let csv="SlNo,Date,BranchCode,BranchName,District,Pincode,In,Out,Remarks\n";
  workData.forEach((x,i)=>{
    csv+=`${i+1},${x.date},${x.code},${x.name},${x.dist},${x.pin},${x.in},${x.out},"${x.rem}"\n`;
  });
  let blob=new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="workmaster.csv";
  a.click();
}

/* CHANGE PASSWORD */
function openChange(){
  mainBox.classList.add("hidden");
  changeBox.classList.remove("hidden");
}

function updatePassword(){
  if(oldPass.value!==currentUser.Password){
    passMsg.innerText="Wrong Old Password"; return;
  }
  if(newPass.value!==confirmPass.value){
    passMsg.innerText="Password Mismatch"; return;
  }
  currentUser.Password=newPass.value;
  passMsg.style.color="green";
  passMsg.innerText="Password Updated (session only)";
}

function back(){
  changeBox.classList.add("hidden");
  mainBox.classList.remove("hidden");
}
</script>

</body>
</html>
