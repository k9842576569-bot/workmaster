<script>
/* ---------- Data holders ---------- */
let staffData = {};
let branchData = {};
let currentUser = null;
let workData = JSON.parse(localStorage.getItem('workData')||'[]');
let editIndex = -1;

/* ---------- load JSONs with FALLBACK ---------- */
fetch('staff_master.json').then(r => r.json()).then(d => staffData = d).catch(e => {
  console.warn('staff_master.json not loaded - using demo users');
  // FALLBACK: Demo users if file missing
  staffData = {
    "001": {Name: "Admin User", Mobile: "9876543210", Password: "admin123", Role: "ADMIN"},
    "002": {Name: "Staff User", Mobile: "9876543211", Password: "staff123", Role: "STAFF"}
  };
});
fetch('branch_master.json').then(r => r.json()).then(d => branchData = d).catch(e => {
  console.warn('branch_master.json not loaded');
  branchData = {}; 
});

/* ---------- ALL OTHER FUNCTIONS SAME AS BEFORE ---------- */
// ... (paste the rest of the functions exactly as provided earlier)
// login(), logout(), searchBranch(), validateFields(), etc. remain identical
function login(){
  const mobile = document.getElementById('loginMobile').value.trim();
  const pass = document.getElementById('loginPassword').value;
  const msg = document.getElementById('loginMsg'); msg.textContent='';

  if(!mobile || !pass){ 
    msg.textContent = 'Enter mobile and password'; 
    msg.style.color = 'var(--err)';
    return; 
  }

  // Wait for staffData OR use fallback after 1s
  const checkLogin = () => {
    for(const key in staffData){
      const u = staffData[key];
      if(u.Mobile===mobile && u.Password===pass){
        currentUser = Object.assign({}, u);
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('appCard').classList.remove('hidden');
        document.getElementById('userInfo').textContent = `Name: ${currentUser.Name}  â€¢  Mobile: ${currentUser.Mobile}`;
        document.getElementById('roleInfo').textContent = `Role: ${currentUser.Role}`;
        document.getElementById('exportBtn').style.display = currentUser.Role==='ADMIN'?'inline-block':'none';
        renderTable();
        return true;
      }
    }
    msg.textContent = Object.keys(staffData).length === 0 ? 
      'Loading users... Check console for staff_master.json' : 
      'Invalid login credentials';
    return false;
  };

  if(Object.keys(staffData).length > 0){
    checkLogin();
  } else {
    // Retry after 1 second if still loading
    setTimeout(checkLogin, 1000);
  }
}

// ... rest of functions unchanged from previous fixed version
// (include formatTime12, to24Hour, updateHiddenTime, etc.)
</script>
