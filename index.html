<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Global Edge Work Master</title>
<style>
  body { font-family: Arial; padding:12px; background:#f4f4f4; }
  .box { max-width:900px; margin:auto; padding:16px; background:#fff; border-radius:8px; }
  input, button { padding:6px; margin:4px 0; }
  table { width: 100%; border-collapse: collapse; margin-top: 16px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #eee; }
  .btn { padding: 4px 8px; cursor:pointer; margin:0 2px; }
  .btn-edit { background: orange; color: white; }
  .btn-delete { background: red; color: white; }
  .btn-export { background: green; color: white; margin-top: 10px; }
  input[type="text"], input[type="date"], input[type="number"] { width: 100%; box-sizing: border-box; }
</style>
</head>
<body>

<div class="box">
  <h2>Global Edge Work Master</h2>

  <!-- Data Entry Section -->
  <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
    <input type="text" id="branchCode" placeholder="Branch Code">
    <input type="text" id="branchName" placeholder="Branch Name" readonly>
    <input type="text" id="district" placeholder="District" readonly>
    <input type="text" id="pincode" placeholder="Pincode" readonly>
    <input type="text" id="inTime" placeholder="In">
    <input type="text" id="outTime" placeholder="Out">
    <input type="text" id="remarks" placeholder="Remarks">
  </div>

  <button onclick="addData()">Add / Update</button>
  <button class="btn-export" onclick="exportTableToExcel('dataTable', 'WorkMaster')">Export to Excel</button>

  <!-- Data Table -->
  <table id="dataTable">
    <thead>
      <tr>
        <th>EntryID</th>
        <th>Mobile</th>
        <th>Branch Code</th>
        <th>Branch Name</th>
        <th>District</th>
        <th>Pincode</th>
        <th>In</th>
        <th>Out</th>
        <th>Remarks</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
// Load branch master
let branchMaster = {};
fetch('branch_master.json')
  .then(res => res.json())
  .then(data => {
    data.forEach(item => {
      branchMaster[item.BRANCH_CODE] = {
        name: item.BANCH_NAME,
        district: item.DISTRICT,
        pincode: item.PINCODE
      };
    });
    console.log("Branch master loaded", branchMaster);
  })
  .catch(err => console.error("Failed to load branch_master.json:", err));

// Auto-fill branch name, district, pincode
document.getElementById('branchCode').addEventListener('input', function() {
    const code = this.value.trim();
    if(branchMaster[code]) {
        document.getElementById('branchName').value = branchMaster[code].name;
        document.getElementById('district').value = branchMaster[code].district;
        document.getElementById('pincode').value = branchMaster[code].pincode;
    } else {
        document.getElementById('branchName').value = '';
        document.getElementById('district').value = '';
        document.getElementById('pincode').value = '';
    }
});

// WorkMaster table
let data = JSON.parse(localStorage.getItem('workData')) || [];
let editIndex = -1;

function renderTable() {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = '';
  data.forEach((item, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.entryID}</td>
      <td>${item.mobile || ''}</td>
      <td>${item.branchCode}</td>
      <td>${item.branchName}</td>
      <td>${item.district}</td>
      <td>${item.pincode}</td>
      <td>${item.inTime}</td>
      <td>${item.outTime}</td>
      <td>${item.remarks}</td>
      <td>
        <button class="btn btn-edit" onclick="editRow(${index})">Edit</button>
        <button class="btn btn-delete" onclick="deleteRow(${index})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function addData() {
  const branchCode = document.getElementById('branchCode').value.trim();
  const branchName = document.getElementById('branchName').value.trim();
  const district = document.getElementById('district').value.trim();
  const pincode = document.getElementById('pincode').value.trim();
  const inTime = document.getElementById('inTime').value.trim();
  const outTime = document.getElementById('outTime').value.trim();
  const remarks = document.getElementById('remarks').value.trim();

  if(!branchCode || !branchName) {
    alert('Please fill Branch Code and ensure it is valid.');
    return;
  }

  let entryID;
  if(editIndex >= 0) {
    entryID = data[editIndex].entryID; // keep existing ID
  } else {
    entryID = data.length ? Math.max(...data.map(d => parseInt(d.entryID))) + 1 : 1; // auto increment
  }

  const record = {
    entryID: entryID,
    mobile: '', // empty for now
    branchCode, branchName, district, pincode, inTime, outTime, remarks
  };

  if(editIndex >= 0) {
    data[editIndex] = record;
    editIndex = -1;
  } else {
    data.push(record);
  }

  localStorage.setItem('workData', JSON.stringify(data));
  clearForm();
  renderTable();
}

function editRow(index) {
  const item = data[index];
  document.getElementById('branchCode').value = item.branchCode;
  document.getElementById('branchName').value = item.branchName;
  document.getElementById('district').value = item.district;
  document.getElementById('pincode').value = item.pincode;
  document.getElementById('inTime').value = item.inTime;
  document.getElementById('outTime').value = item.outTime;
  document.getElementById('remarks').value = item.remarks;
  editIndex = index;
}

function deleteRow(index) {
  if(confirm('Are you sure you want to delete this record?')) {
    data.splice(index,1);
    localStorage.setItem('workData', JSON.stringify(data));
    renderTable();
  }
}

function clearForm() {
  document.getElementById('branchCode').value = '';
  document.getElementById('branchName').value = '';
  document.getElementById('district').value = '';
  document.getElementById('pincode').value = '';
  document.getElementById('inTime').value = '';
  document.getElementById('outTime').value = '';
  document.getElementById('remarks').value = '';
}

function exportTableToExcel(tableID, filename = '') {
  const table = document.getElementById(tableID);
  const rows = Array.from(table.rows);
  let csv = rows.map(row => Array.from(row.cells)
      .slice(0,-1) // skip action column
      .map(cell => `"${cell.innerText}"`).join(",")).join("\n");

  const blob = new Blob([csv], { type: 'text/csv' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename ? filename + '.csv' : 'export.csv';
  link.click();
}

renderTable(); // render on page load
</script>
</body>
</html>
