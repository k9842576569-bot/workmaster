<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Global Edge Work Master</title>
<style>
  body { font-family: Arial; padding:12px; background:#f4f4f4; }
  .box { max-width:950px; margin:auto; padding:16px; background:#fff; border-radius:8px; }
  input, button, textarea, select { padding:6px; margin:4px 0; box-sizing:border-box; }
  table { width: 100%; border-collapse: collapse; margin-top: 16px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
  th { background: #eee; }
  .btn { padding: 4px 8px; cursor:pointer; margin:0 2px; }
  .btn-edit { background: orange; color: white; }
  .btn-delete { background: red; color: white; }
  .btn-export { background: green; color: white; margin-top: 10px; }
  td.remarks-cell { max-width: 250px; word-wrap: break-word; white-space: pre-wrap; }
  input[type="text"], select, textarea { width: 100%; }
  .branch-row { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
  .time-row { display:flex; gap:4px; align-items:center; }
</style>
</head>
<body>

<div class="box">
  <h2>Global Edge Work Master</h2>

  <!-- Branch input row with Search button -->
  <div class="branch-row">
    <input type="text" id="branchCode" placeholder="Enter Branch Code" style="flex:2;">
    <button type="button" onclick="fillBranch()" style="flex:1;">Search</button>
    <input type="text" id="branchName" placeholder="Branch Name" readonly style="flex:3;">
  </div>

  <!-- Hidden district/pincode for future use -->
  <input type="text" id="district" placeholder="District" style="display:none;">
  <input type="text" id="pincode" placeholder="Pincode" style="display:none;">

  <!-- In/Out time dropdowns -->
  <div class="time-row">
    <label>In:</label>
    <select id="inHour">${Array.from({length:12},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}</select>
    :
    <select id="inMinute">${Array.from({length:60},(_,i)=>`<option value="${i.toString().padStart(2,'0')}">${i.toString().padStart(2,'0')}</option>`).join('')}</select>
    <select id="inAMPM"><option value="AM">AM</option><option value="PM">PM</option></select>

    <label style="margin-left:20px;">Out:</label>
    <select id="outHour">${Array.from({length:12},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}</select>
    :
    <select id="outMinute">${Array.from({length:60},(_,i)=>`<option value="${i.toString().padStart(2,'0')}">${i.toString().padStart(2,'0')}</option>`).join('')}</select>
    <select id="outAMPM"><option value="AM">AM</option><option value="PM">PM</option></select>
  </div>

  <!-- Remarks -->
  <textarea id="remarks" placeholder="Remarks" rows="3" style="width:100%;"></textarea>

  <button onclick="addData()">Add / Update</button>
  <button class="btn-export" onclick="exportTableToExcel('dataTable', 'WorkMaster')">Export to Excel</button>

  <!-- Data Table -->
  <table id="dataTable">
    <thead>
      <tr>
        <th>EntryID</th>
        <th>Mobile</th>
        <th>Branch Code</th>
        <th>Branch Name</th>
        <th>District</th>
        <th>Pincode</th>
        <th>In</th>
        <th>Out</th>
        <th>Remarks</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
// Load keyed branch master JSON
let branchMaster = {};
let branchLoaded = false;

fetch('branch_master.json')
  .then(res => res.json())
  .then(data => { branchMaster = data; branchLoaded = true; })
  .catch(err => console.error("Failed to load branch_master.json:", err));

// Format selected time as "HH:MM AM/PM"
function getTime(idHour, idMinute, idAMPM) {
  return document.getElementById(idHour).value + ':' + 
         document.getElementById(idMinute).value + ' ' +
         document.getElementById(idAMPM).value;
}

// Auto-fill branch details
function fillBranch() {
    if(!branchLoaded) { alert('Branch data is still loading.'); return; }

    const code = document.getElementById('branchCode').value.trim();
    if(!code) return;

    const branch = branchMaster[code];
    if(branch){
        document.getElementById('branchName').value = branch.BANCH_NAME;
        document.getElementById('district').value = branch.DISTRICT;
        document.getElementById('pincode').value = branch.PINCODE;
    } else {
        alert('Branch Code not found!');
        document.getElementById('branchName').value = '';
        document.getElementById('district').value = '';
        document.getElementById('pincode').value = '';
    }
}

// Auto-fill on Tab/Enter (desktop)
document.getElementById('branchCode').addEventListener('keydown', function(e) {
    if(e.key === 'Tab' || e.key === 'Enter') fillBranch();
});

// Auto-fill on blur (mobile)
document.getElementById('branchCode').addEventListener('blur', fillBranch);

// WorkMaster table
let data = JSON.parse(localStorage.getItem('workData')) || [];
let editIndex = -1;

function renderTable() {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = '';
  data.forEach((item, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.entryID}</td>
      <td>${item.mobile || ''}</td>
      <td>${item.branchCode}</td>
      <td>${item.branchName}</td>
      <td>${item.district}</td>
      <td>${item.pincode}</td>
      <td>${item.inTime}</td>
      <td>${item.outTime}</td>
      <td class="remarks-cell">${item.remarks}</td>
      <td>
        <button class="btn btn-edit" onclick="editRow(${index})">Edit</button>
        <button class="btn btn-delete" onclick="deleteRow(${index})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function addData() {
  const branchCode = document.getElementById('branchCode').value.trim();
  const branchName = document.getElementById('branchName').value.trim();
  const district = document.getElementById('district').value;
  const pincode = document.getElementById('pincode').value;
  const inTime = getTime('inHour','inMinute','inAMPM');
  const outTime = getTime('outHour','outMinute','outAMPM');
  const remarks = document.getElementById('remarks').value.trim();

  if(!branchCode || !branchName) {
    alert('Please enter a valid Branch Code.');
    return;
  }

  let entryID;
  if(editIndex >= 0) {
    entryID = data[editIndex].entryID;
  } else {
    entryID = data.length ? Math.max(...data.map(d => parseInt(d.entryID))) + 1 : 1;
  }

  const record = { entryID, mobile:'', branchCode, branchName, district, pincode, inTime, outTime, remarks };

  if(editIndex >= 0) {
    data[editIndex] = record;
    editIndex = -1;
  } else {
    data.push(record);
  }

  localStorage.setItem('workData', JSON.stringify(data));
  clearForm();
  renderTable();
}

function editRow(index) {
  const item = data[index];
  document.getElementById('branchCode').value = item.branchCode;
  document.getElementById('branchName').value = item.branchName;
  document.getElementById('district').value = item.district;
  document.getElementById('pincode').value = item.pincode;

  // Split inTime
  let [inHMin, inAMPM] = item.inTime.split(' ');
  let [inH, inM] = inHMin.split(':');
  document.getElementById('inHour').value = inH;
  document.getElementById('inMinute').value = inM;
  document.getElementById('inAMPM').value = inAMPM;

  // Split outTime
  let [outHMin, outAMPM] = item.outTime.split(' ');
  let [outH, outM] = outHMin.split(':');
  document.getElementById('outHour').value = outH;
  document.getElementById('outMinute').value = outM;
  document.getElementById('outAMPM').value = outAMPM;

  document.getElementById('remarks').value = item.remarks;
  editIndex = index;
}

function deleteRow(index) {
  if(confirm('Are you sure you want to delete this record?')) {
    data.splice(index,1);
    localStorage.setItem('workData', JSON.stringify(data));
    renderTable();
  }
}

function clearForm() {
  document.getElementById('branchCode').value = '';
  document.getElementById('branchName').value = '';
  document.getElementById('district').value = '';
  document.getElementById('pincode').value = '';
  document.getElementById('remarks').value = '';
  document.getElementById('inHour').value = 1;
  document.getElementById('inMinute').value = '00';
  document.getElementById('inAMPM').value = 'AM';
  document.getElementById('outHour').value = 1;
  document.getElementById('outMinute').value = '00';
  document.getElementById('outAMPM').value = 'AM';
}

function exportTableToExcel(tableID, filename = '') {
  const table = document.getElementById(tableID);
  const rows = Array.from(table.rows);
  let csv = rows.map(row => Array.from(row.cells)
      .slice(0,-1)
      .map(cell => `"${cell.innerText}"`).join(",")).join("\n");

  const blob = new Blob([csv], { type: 'text/csv' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename ? filename + '.csv' : 'export.csv';
  link.click();
}

renderTable();
</script>
</body>
</html>
