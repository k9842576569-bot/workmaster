<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Global Edge Work Master</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f2f2f2;padding:10px;}
.box{max-width:1000px;margin:auto;background:#fff;padding:15px;border-radius:8px;}
input,button,textarea,select{padding:8px;font-size:16px;margin:4px 0;width:100%;}
button{background:#007bff;color:white;border:none;border-radius:5px;}
.hidden{display:none;}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;}
td,th{border:1px solid #ccc;padding:6px;text-align:left;}
th{background:#eee;}
.search-row,.time-row{display:flex;gap:6px;}
.search-row input,.time-row input{flex:1;}
.search-row button{width:120px;background:#28a745;}
.editBtn{background:orange;}
.delBtn{background:red;}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
<h3>Staff Login</h3>
<input id="loginMobile" placeholder="Mobile Number">
<input id="loginPassword" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<p id="loginError" style="color:red;"></p>
</div>

<!-- MAIN -->
<div class="box hidden" id="mainBox">
<h3 id="welcome"></h3>
<p id="role" style="color:green;"></p>

<label>Work Date</label>
<input type="date" id="workDate">

<div class="search-row">
  <input id="branchCode" placeholder="Branch Code">
  <button onclick="searchBranch()">SEARCH</button>
</div>

<input id="branchName" placeholder="Branch Name" readonly>
<input type="hidden" id="district">
<input type="hidden" id="pincode">

<label>In Time</label>
<div class="time-row">
  <input id="inTime" placeholder="HH:MM">
  <select id="inAmPm"><option>AM</option><option>PM</option></select>
</div>

<label>Out Time</label>
<div class="time-row">
  <input id="outTime" placeholder="HH:MM">
  <select id="outAmPm"><option>AM</option><option>PM</option></select>
</div>

<textarea id="remarks" placeholder="Remarks (long text allowed)"></textarea>

<button onclick="addEntry()" id="saveBtn">SAVE ENTRY</button>
<button id="exportBtn" onclick="exportExcel()">EXPORT EXCEL</button>
<button onclick="logout()" style="background:red;">LOGOUT</button>

<table>
<thead>
<tr>
<th>Sl</th><th>Date</th><th>Code</th><th>Branch</th>
<th>District</th><th>Pincode</th>
<th>In</th><th>Out</th><th>Remarks</th><th>Action</th>
</tr>
</thead>
<tbody id="dataBody"></tbody>
</table>

</div>

<script>
let staffData={}, branchData={}, currentUser=null;
let workData = JSON.parse(localStorage.getItem("workData")) || [];
let editIndex = -1;

fetch("staff_master.json").then(r=>r.json()).then(d=>staffData=d);
fetch("branch_master.json").then(r=>r.json()).then(d=>branchData=d);

function login(){
  for(let k in staffData){
    if(staffData[k].Mobile===loginMobile.value && staffData[k].Password===loginPassword.value){
      currentUser = staffData[k];
      loginBox.classList.add("hidden");
      mainBox.classList.remove("hidden");
      welcome.innerText = "Welcome: " + currentUser.Name;
      role.innerText = "Role: " + currentUser.Role;
      exportBtn.style.display = currentUser.Role==="ADMIN" ? "block" : "none";
      render();
      return;
    }
  }
  loginError.innerText="Invalid Login!";
}

function logout(){ location.reload(); }

function searchBranch(){
  let code = branchCode.value.trim();
  if(branchData[code]){
    branchName.value = branchData[code].BANCH_NAME;
    district.value = branchData[code].DISTRICT;
    pincode.value = branchData[code].PINCODE;
  } else {
    alert("Branch Not Found!");
    branchName.value="";
  }
}

function addEntry(){
  let date=workDate.value.trim(), code=branchCode.value.trim();
  if(!date||!code||!branchName.value){ alert("Date & Branch Required"); return; }

  if(editIndex===-1){
    let duplicate = workData.some(x => x.date===date && x.code===code);
    if(duplicate){ alert("âŒ Duplicate Blocked!"); return; }
  }

  let rec={
    date, code,
    name:branchName.value,
    dist:district.value,
    pin:pincode.value,
    in:inTime.value+" "+inAmPm.value,
    out:outTime.value+" "+outAmPm.value,
    rem:remarks.value
  };

  if(editIndex>=0){
    workData[editIndex]=rec;
    editIndex=-1;
    saveBtn.innerText="SAVE ENTRY";
  } else {
    workData.push(rec);
  }

  localStorage.setItem("workData",JSON.stringify(workData));
  clearForm();
  render();
}

function render(){
  dataBody.innerHTML="";
  workData.forEach((x,i)=>{
    dataBody.innerHTML+=`
    <tr>
      <td>${i+1}</td>
      <td>${x.date}</td>
      <td>${x.code}</td>
      <td>${x.name}</td>
      <td>${x.dist}</td>
      <td>${x.pin}</td>
      <td>${x.in}</td>
      <td>${x.out}</td>
      <td>${x.rem}</td>
      <td>
        <button class="editBtn" onclick="editRow(${i})">Edit</button>
        <button class="delBtn" onclick="deleteRow(${i})">Delete</button>
      </td>
    </tr>`;
  });
}

function editRow(i){
  let x=workData[i];
  workDate.value=x.date;
  branchCode.value=x.code;
  branchName.value=x.name;
  district.value=x.dist;
  pincode.value=x.pin;
  let inSplit=x.in.split(" "); inTime.value=inSplit[0]; inAmPm.value=inSplit[1];
  let outSplit=x.out.split(" "); outTime.value=outSplit[0]; outAmPm.value=outSplit[1];
  remarks.value=x.rem;
  editIndex=i;
  saveBtn.innerText="UPDATE";
}

function deleteRow(i){
  if(confirm("Delete this record?")){
    workData.splice(i,1);
    localStorage.setItem("workData",JSON.stringify(workData));
    render();
  }
}

function clearForm(){
  workDate.value="";
  branchCode.value="";
  branchName.value="";
  district.value="";
  pincode.value="";
  inTime.value="";
  outTime.value="";
  remarks.value="";
}

function exportExcel(){
  let csv="SlNo,Date,BranchCode,BranchName,District,Pincode,In,Out,Remarks\n";
  workData.forEach((x,i)=>{
    csv+=`${i+1},${x.date},${x.code},${x.name},${x.dist},${x.pin},${x.in},${x.out},"${x.rem}"\n`;
  });
  let blob=new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="workmaster.csv";
  a.click();
}
</script>

</body>
</html>
