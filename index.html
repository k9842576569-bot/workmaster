<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure Staff Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Arial;
  background:#f4f4f4;
  padding:20px;
}
.box{
  max-width:420px;
  margin:auto;
  background:white;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #999;
}
input, button{
  width:100%;
  padding:10px;
  margin-top:10px;
  font-size:16px;
}
button{
  background:#007bff;
  color:white;
  border:none;
  border-radius:5px;
}
button:disabled{
  background:gray;
}
.hidden{display:none;}
h2{text-align:center;}
.role{font-weight:bold;color:green;text-align:center;}
.error{color:red;text-align:center;}
.success{color:green;text-align:center;}
</style>
</head>

<body>

<!-- ================= LOGIN SCREEN ================= -->
<div class="box" id="loginBox">
  <h2>Staff Login</h2>
  <input type="tel" id="mobileInput" placeholder="Mobile Number">
  <input type="password" id="passwordInput" placeholder="Password">
  <button onclick="login()">Login</button>
  <p id="loginError" class="error"></p>
</div>

<!-- ================= DASHBOARD ================= -->
<div class="box hidden" id="dashboard">
  <h2>Welcome</h2>
  <p id="staffName" style="text-align:center;"></p>
  <p id="staffRole" class="role"></p>

  <button id="excelBtn" onclick="exportExcel()">Export Excel</button>
  <button onclick="openChangePassword()">Change Password</button>
  <button onclick="logout()" style="background:red;">Logout</button>
</div>

<!-- ================= CHANGE PASSWORD ================= -->
<div class="box hidden" id="changePassBox">
  <h2>Change Password</h2>
  <input type="password" id="oldPass" placeholder="Old Password">
  <input type="password" id="newPass" placeholder="New Password">
  <input type="password" id="confirmPass" placeholder="Confirm New Password">
  <button onclick="changePassword()">Update Password</button>
  <button onclick="backToDashboard()" style="background:gray;">Back</button>
  <p id="passMsg" class="error"></p>
</div>

<script>
let staffData = {};
let currentUserKey = null;

/* ✅ Load Staff JSON */
fetch("staff_master.json")
  .then(res => res.json())
  .then(data => staffData = data)
  .catch(err => alert("staff_master.json not found!"));

/* ✅ Login Function */
function login(){
  const mobile = document.getElementById("mobileInput").value.trim();
  const pass = document.getElementById("passwordInput").value.trim();
  const error = document.getElementById("loginError");

  error.innerText = "";

  if(mobile === "" || pass === ""){
    error.innerText = "All fields required!";
    return;
  }

  let foundKey = null;

  for(let key in staffData){
    if(staffData[key].Mobile === mobile && staffData[key].Password === pass){
      foundKey = key;
      break;
    }
  }

  if(!foundKey){
    error.innerText = "Invalid Login Details!";
    return;
  }

  currentUserKey = foundKey;
  const user = staffData[foundKey];

  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");

  document.getElementById("staffName").innerText = "Name: " + user.Name;
  document.getElementById("staffRole").innerText = "Role: " + user.Role;

  if(user.Role === "ADMIN"){
    document.getElementById("excelBtn").disabled = false;
  }else{
    document.getElementById("excelBtn").disabled = true;
  }
}

/* ✅ Excel Dummy */
function exportExcel(){
  alert("Excel Export Allowed (ADMIN Only)");
}

/* ✅ Open Change Password */
function openChangePassword(){
  document.getElementById("dashboard").classList.add("hidden");
  document.getElementById("changePassBox").classList.remove("hidden");
  document.getElementById("passMsg").innerText = "";
}

/* ✅ Update Password */
function changePassword(){
  const oldP = document.getElementById("oldPass").value.trim();
  const newP = document.getElementById("newPass").value.trim();
  const confP = document.getElementById("confirmPass").value.trim();
  const msg = document.getElementById("passMsg");

  msg.innerText = "";

  if(oldP === "" || newP === "" || confP === ""){
    msg.innerText = "All fields required!";
    return;
  }

  if(staffData[currentUserKey].Password !== oldP){
    msg.innerText = "Old password incorrect!";
    return;
  }

  if(newP !== confP){
    msg.innerText = "New passwords not match!";
    return;
  }

  staffData[currentUserKey].Password = newP;
  msg.className = "success";
  msg.innerText = "Password Updated Successfully (Session Only)";

  document.getElementById("oldPass").value = "";
  document.getElementById("newPass").value = "";
  document.getElementById("confirmPass").value = "";
}

/* ✅ Back to Dashboard */
function backToDashboard(){
  document.getElementById("changePassBox").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");
}

/* ✅ Logout */
function logout(){
  currentUserKey = null;
  document.getElementById("mobileInput").value = "";
  document.getElementById("passwordInput").value = "";
  document.getElementById("loginError").innerText = "";

  document.getElementById("dashboard").classList.add("hidden");
  document.getElementById("changePassBox").classList.add("hidden");
  document.getElementById("loginBox").classList.remove("hidden");
}
</script>

</body>
</html>
