<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Work Master â€“ 12 Hour</title>

<style>
body{font-family:Arial;background:#f4f6f8;padding:12px}
.card{max-width:1000px;margin:auto;background:#fff;padding:15px;border-radius:8px}
.row{display:flex;gap:10px;flex-wrap:wrap}
input,select,textarea,button{padding:8px;font-size:15px}
label{font-weight:bold;margin-top:8px;display:block}
button{cursor:pointer}
.hidden{display:none}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;font-size:14px}
th{background:#eee}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h2>Staff Login</h2>

  <label>Mobile</label>
  <input id="loginMobile">

  <label>Password</label>
  <input id="loginPassword" type="password">

  <br><br>
  <button onclick="login()">Login</button>
  <p id="loginMsg" style="color:red"></p>
</div>

<!-- APP -->
<div class="card hidden" id="appCard">
  <h2>Work Entry</h2>
  <p id="userInfo"></p>

  <label>Date</label>
  <input type="date" id="workDate">

  <label>Branch Code</label>
  <div class="row">
    <input id="branchCode">
    <button onclick="searchBranch()">Search</button>
  </div>

  <label>Branch Name</label>
  <input id="branchName" readonly>

  <div class="row">
    <div>
      <label>In Time</label>
      <input id="inTime" placeholder="01:30">
      <select id="inAmPm">
        <option>AM</option>
        <option>PM</option>
      </select>
    </div>

    <div>
      <label>Out Time</label>
      <input id="outTime" placeholder="06:00">
      <select id="outAmPm">
        <option>AM</option>
        <option>PM</option>
      </select>
    </div>
  </div>

  <label>Remarks</label>
  <textarea id="remarks"></textarea>

  <br>
  <button onclick="saveData()">Save</button>
  <button onclick="logout()">Logout</button>

  <h3>Saved Records</h3>
  <table>
    <thead>
      <tr>
        <th>#</th><th>Date</th><th>Code</th><th>Name</th>
        <th>In</th><th>Out</th><th>Remarks</th>
      </tr>
    </thead>
    <tbody id="dataBody"></tbody>
  </table>
</div>

<script>
let staffData = {};
let branchData = {};
let currentUser = null;
let workData = JSON.parse(localStorage.getItem("workData")||"[]");

/* LOAD STAFF */
fetch("./staff_master.json")
.then(r=>r.json())
.then(d=>staffData=d)
.catch(()=>alert("staff_master.json not loaded"));

/* LOAD BRANCH */
fetch("./branch_master.json")
.then(r=>r.json())
.then(d=>branchData=d)
.catch(()=>alert("branch_master.json not loaded"));

/* LOGIN */
function login(){
  const m = loginMobile.value.trim();
  const p = loginPassword.value.trim();
  loginMsg.textContent="";

  for(const k in staffData){
    const u = staffData[k];
    if(u.Mobile===m && u.Password===p){
      currentUser=u;
      loginCard.classList.add("hidden");
      appCard.classList.remove("hidden");
      userInfo.textContent="Logged in as: "+u.Name+" ("+u.Role+")";
      render();
      return;
    }
  }
  loginMsg.textContent="Invalid User ID or Password";
}

/* LOGOUT */
function logout(){
  currentUser=null;
  loginCard.classList.remove("hidden");
  appCard.classList.add("hidden");
}

/* BRANCH SEARCH */
function searchBranch(){
  const b = branchData[branchCode.value.trim()];
  if(!b){ alert("Branch not found"); return; }
  branchName.value = b.BRANCH_NAME || "";
}

/* TIME PARSE (12 HOUR) */
function parseTime(t, ap){
  const r=/^(0[1-9]|1[0-2]):[0-5][0-9]$/;
  if(!r.test(t)) return null;
  let [h,m]=t.split(":").map(Number);
  if(h===12) h=0;
  if(ap==="PM") h+=12;
  return h*60+m;
}

/* SAVE */
function saveData(){
  const inM=parseTime(inTime.value,inAmPm.value);
  const outM=parseTime(outTime.value,outAmPm.value);

  if(!workDate.value||!branchCode.value||!branchName.value){
    alert("Fill all required fields");
    return;
  }
  if(inM===null||outM===null||outM<=inM){
    alert("Invalid time");
    return;
  }

  workData.push({
    date:workDate.value,
    code:branchCode.value,
    name:branchName.value,
    in:inTime.value+" "+inAmPm.value,
    out:outTime.value+" "+outAmPm.value,
    rem:remarks.value,
    staff:currentUser.Name
  });

  localStorage.setItem("workData",JSON.stringify(workData));
  clearForm();
  render();
}

/* TABLE */
function render(){
  dataBody.innerHTML="";
  workData.forEach((r,i)=>{
    dataBody.innerHTML+=`
    <tr>
      <td>${i+1}</td>
      <td>${r.date}</td>
      <td>${r.code}</td>
      <td>${r.name}</td>
      <td>${r.in}</td>
      <td>${r.out}</td>
      <td>${r.rem||""}</td>
    </tr>`;
  });
}

/* CLEAR */
function clearForm(){
  workDate.value="";
  branchCode.value="";
  branchName.value="";
  inTime.value="";
  outTime.value="";
  remarks.value="";
}
</script>

</body>
</html>
