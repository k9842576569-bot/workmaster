<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Global Edge Work Master</title>
<style>
body { font-family: Arial; padding:12px; background:#f4f4f4; }
.box { max-width:1000px; margin:auto; padding:16px; background:#fff; border-radius:8px; }
input, select, textarea, button { width:100%; padding:6px; margin:4px 0; }
table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { border:1px solid #ccc; padding:6px; text-align:left; }
th { background:#eee; }
.btn { padding:4px 8px; cursor:pointer; }
.btn-edit { background:orange; color:#fff; }
.btn-delete { background:red; color:#fff; }
.btn-export { background:green; color:#fff; margin-top:10px; }
.row { display:flex; gap:8px; flex-wrap:wrap; }
.col { flex:1; }
.time-row { display:flex; gap:5px; align-items:center; }
td { vertical-align:top; white-space:pre-wrap; word-break:break-word; }
</style>
</head>

<body>
<div class="box">
<h2>Global Edge Work Master</h2>

<!-- Branch -->
<div class="row">
  <div class="col"><input id="branchCode" placeholder="Branch Code"></div>
  <div class="col"><button onclick="fillBranch()">Search</button></div>
  <div class="col"><input id="branchName" placeholder="Branch Name" readonly></div>
</div>

<!-- Hidden for future -->
<input id="district" style="display:none">
<input id="pincode" style="display:none">

<!-- Time -->
<div class="row">
  <div class="col time-row">
    <b>In:</b>
    <select id="inHour"></select> :
    <select id="inMinute"></select>
    <select id="inAMPM">
      <option>AM</option><option>PM</option>
    </select>
  </div>

  <div class="col time-row">
    <b>Out:</b>
    <select id="outHour"></select> :
    <select id="outMinute"></select>
    <select id="outAMPM">
      <option>AM</option><option>PM</option>
    </select>
  </div>
</div>

<textarea id="remarks" rows="4" placeholder="Remarks (Long text supported)"></textarea>

<button onclick="addData()">Add / Update</button>
<button class="btn-export" onclick="exportExcel()">Export to Excel</button>

<table id="table">
<thead>
<tr>
<th>ID</th><th>Branch Code</th><th>Branch Name</th>
<th>District</th><th>Pincode</th>
<th>In</th><th>Out</th>
<th>Remarks</th><th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
// ✅ POPULATE TIME DROPDOWNS ✅
function loadTime() {
  for(let i=1;i<=12;i++){
    inHour.innerHTML += `<option>${i}</option>`;
    outHour.innerHTML += `<option>${i}</option>`;
  }
  for(let i=0;i<60;i++){
    let m = i.toString().padStart(2,"0");
    inMinute.innerHTML += `<option>${m}</option>`;
    outMinute.innerHTML += `<option>${m}</option>`;
  }
}
loadTime();

// ✅ LOAD BRANCH JSON ✅
let branchMaster = {};
fetch("branch_master.json")
.then(r => r.json())
.then(d => branchMaster = d);

// ✅ AUTO SEARCH ✅
function fillBranch(){
  let code = branchCode.value.trim();
  let b = branchMaster[code];
  if(!b){
    alert("Branch Code Not Found!");
    branchName.value = "";
    district.value = "";
    pincode.value = "";
    return;
  }
  branchName.value = b.BANCH_NAME;
  district.value = b.DISTRICT;
  pincode.value = b.PINCODE;
}

branchCode.addEventListener("blur", fillBranch);

// ✅ STORAGE ✅
let data = JSON.parse(localStorage.getItem("work")) || [];
let edit = -1;

function addData(){
  if(!branchCode.value || !branchName.value){
    alert("Enter valid Branch Code");
    return;
  }

  let inTime = `${inHour.value}:${inMinute.value} ${inAMPM.value}`;
  let outTime = `${outHour.value}:${outMinute.value} ${outAMPM.value}`;

  let id = edit>=0 ? data[edit].id : (data.length+1);

  let rec = {
    id, branchCode:branchCode.value, branchName:branchName.value,
    district:district.value, pincode:pincode.value,
    inTime, outTime, remarks:remarks.value
  };

  if(edit>=0){ data[edit]=rec; edit=-1; }
  else data.push(rec);

  localStorage.setItem("work", JSON.stringify(data));
  clear();
  render();
}

function render(){
  let tbody = document.querySelector("#table tbody");
  tbody.innerHTML = "";
  data.forEach((r,i)=>{
    tbody.innerHTML += `
    <tr>
    <td>${r.id}</td><td>${r.branchCode}</td><td>${r.branchName}</td>
    <td>${r.district}</td><td>${r.pincode}</td>
    <td>${r.inTime}</td><td>${r.outTime}</td>
    <td>${r.remarks}</td>
    <td>
      <button class="btn btn-edit" onclick="editRow(${i})">Edit</button>
      <button class="btn btn-delete" onclick="delRow(${i})">Del</button>
    </td>
    </tr>`;
  });
}

function editRow(i){
  let r=data[i];
  branchCode.value=r.branchCode;
  fillBranch();
  let a=r.inTime.split(/[: ]/);
  inHour.value=a[0]; inMinute.value=a[1]; inAMPM.value=a[2];
  let b=r.outTime.split(/[: ]/);
  outHour.value=b[0]; outMinute.value=b[1]; outAMPM.value=b[2];
  remarks.value=r.remarks;
  edit=i;
}

function delRow(i){
  if(confirm("Delete?")){
    data.splice(i,1);
    localStorage.setItem("work",JSON.stringify(data));
    render();
  }
}

function clear(){
  branchCode.value=""; branchName.value=""; remarks.value="";
}

function exportExcel(){
  let csv=["ID,BranchCode,BranchName,District,Pincode,In,Out,Remarks"];
  data.forEach(r=>{
    csv.push(`${r.id},${r.branchCode},${r.branchName},${r.district},${r.pincode},${r.inTime},${r.outTime},"${r.remarks}"`);
  });
  let blob=new Blob([csv.join("\n")],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="workmaster.csv"; a.click();
}

render();
</script>
</body>
</html>
