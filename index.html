<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Global Edge Work Master</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f2f2f2;padding:10px;}
.box{max-width:900px;margin:auto;background:#fff;padding:15px;border-radius:8px;box-shadow:0 0 10px #aaa;}
input,button,textarea,select{padding:10px;font-size:16px;margin:5px 0;width:100%;}
button{background:#007bff;color:white;border:none;border-radius:5px;}
.hidden{display:none;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
td,th{border:1px solid #ccc;padding:6px;}
th{background:#eee;}
.role{color:green;font-weight:bold;}
textarea{height:120px;}

.search-row{display:flex;gap:6px;}
.search-row input{flex:1;}
.search-row button{width:120px;background:#28a745;}

.time-row{display:flex;gap:6px;}
.time-row input{flex:1;}
.time-row select{width:90px;}
</style>
</head>

<body>

<div class="box" id="loginBox">
<h2>Staff Login</h2>
<input id="loginMobile" placeholder="Mobile Number">
<input id="loginPassword" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<p id="loginError" style="color:red;"></p>
</div>

<div class="box hidden" id="mainBox">
<h2>Work Master</h2>
<p id="welcome"></p>
<p id="role" class="role"></p>

<label>Work Date</label>
<input type="date" id="workDate">

<div class="search-row">
  <input id="branchCode" placeholder="Enter Branch Code">
  <button onclick="searchBranch()">SEARCH</button>
</div>

<input id="branchName" placeholder="Branch Name" readonly>
<input type="hidden" id="district">
<input type="hidden" id="pincode">

<label>In Time</label>
<div class="time-row">
  <input id="inTime">
  <select id="inAmPm"><option>AM</option><option>PM</option></select>
</div>

<label>Out Time</label>
<div class="time-row">
  <input id="outTime">
  <select id="outAmPm"><option>AM</option><option>PM</option></select>
</div>

<textarea id="remarks" placeholder="Remarks"></textarea>

<button onclick="addEntry()">SAVE ENTRY</button>
<button id="exportBtn" onclick="exportExcel()">EXPORT EXCEL</button>
<button onclick="logout()" style="background:red;">LOGOUT</button>

<table>
<thead>
<tr>
<th>SlNo</th>
<th>Date</th>
<th>Branch Code</th>
<th>Branch Name</th>
<th>District</th>
<th>Pincode</th>
<th>In</th>
<th>Out</th>
<th>Remarks</th>
</tr>
</thead>
<tbody id="dataBody"></tbody>
</table>

<p id="msg" style="color:green;"></p>
</div>

<script>
let staffData={}, branchData={}, currentUser=null;
let workData = JSON.parse(localStorage.getItem("workData")) || [];

fetch("staff_master.json").then(r=>r.json()).then(d=>staffData=d);
fetch("branch_master.json").then(r=>r.json()).then(d=>branchData=d);

function login(){
  for(let k in staffData){
    if(staffData[k].Mobile===loginMobile.value && staffData[k].Password===loginPassword.value){
      currentUser = staffData[k];
      loginBox.classList.add("hidden");
      mainBox.classList.remove("hidden");
      welcome.innerText = "Welcome: " + currentUser.Name;
      role.innerText = "Role: " + currentUser.Role;
      exportBtn.style.display = currentUser.Role==="ADMIN" ? "block" : "none";
      render();
      return;
    }
  }
  loginError.innerText="Invalid Login!";
}

function logout(){ location.reload(); }

function searchBranch(){
  let code = branchCode.value.trim();
  if(branchData[code]){
    branchName.value = branchData[code].BANCH_NAME;
    district.value = branchData[code].DISTRICT;
    pincode.value = branchData[code].PINCODE;
  }else{
    alert("Branch Code Not Found!");
    branchName.value="";
  }
}

/* ✅ ✅ ✅ FINAL DUPLICATE BLOCK LOGIC ✅ ✅ ✅ */
function addEntry(){

  let date = workDate.value.trim();
  let code = String(branchCode.value.trim());

  if(!date || !code || !branchName.value){
    alert("Date & Branch are required");
    return;
  }

  let isDuplicate = workData.some(x => 
      String(x.date).trim() === date && 
      String(x.code).trim() === code
  );

  if(isDuplicate){
    alert("❌ DUPLICATE BLOCKED!\nThis Branch is already entered for the same date.");
    return; // ✅ HARD STOP
  }

  let rec = {
    date: date,
    code: code,
    name: branchName.value,
    dist: district.value,
    pin: pincode.value,
    in: inTime.value + " " + inAmPm.value,
    out: outTime.value + " " + outAmPm.value,
    rem: remarks.value
  };

  workData.push(rec);
  localStorage.setItem("workData",JSON.stringify(workData));

  msg.innerText="✅ Saved Successfully";
  render();
}

function render(){
  dataBody.innerHTML="";
  workData.forEach((x,i)=>{
    dataBody.innerHTML+=`
    <tr>
    <td>${i+1}</td>
    <td>${x.date}</td>
    <td>${x.code}</td>
    <td>${x.name}</td>
    <td>${x.dist}</td>
    <td>${x.pin}</td>
    <td>${x.in}</td>
    <td>${x.out}</td>
    <td>${x.rem}</td>
    </tr>`;
  });
}

function exportExcel(){
  let csv="SlNo,Date,BranchCode,BranchName,District,Pincode,In,Out,Remarks\n";
  workData.forEach((x,i)=>{
    csv+=`${i+1},${x.date},${x.code},${x.name},${x.dist},${x.pin},${x.in},${x.out},"${x.rem}"\n`;
  });
  let blob=new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="workmaster.csv";
  a.click();
}
</script>

</body>
</html>
